#!/bin/bash

set +e  # Don't exit immediately if a command exits with a non-zero status

#-----------------------------------------------------------------------------

iverilog_has_priority=1
vsim_has_priority=1

#-----------------------------------------------------------------------------

readonly script=$(basename "$0")

#-----------------------------------------------------------------------------

IVERILOG=iverilog
VVP=vvp

GTKWAVE=gtkwave

if [ ${OSTYPE/[0-9]*/} = "darwin" ]
then
    GTKWAVE=/Applications/gtkwave.app/Contents/MacOS/gtkwave-bin
fi

VSIM=vsim

#-----------------------------------------------------------------------------

export MODELSIM_ROOTDIR="$HOME/intelFPGA_lite/18.1/modelsim_ase"
export PATH="${PATH}:$MODELSIM_ROOTDIR/bin"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$MODELSIM_ROOTDIR/lib32"

#-----------------------------------------------------------------------------

SIM_DIR=${PWD}/sim
SYN_DIR=${PWD}/syn

#-----------------------------------------------------------------------------

is_number ()
{
    # Работает в sh?
    # [ "$1" != "" ] && echo $1 | grep -q ^[0-9]*$
    # Работает только в bash
    # [ "$1" != "" ] && grep -q <<< "$1" ^[0-9]*$
    # Работает только в bash ?
    test -n "${1##*[!0-9]*}"
}

#-----------------------------------------------------------------------------

error ()
{
    if is_number $1
    then
        ec=$1
        shift
    else
        ec=1
    fi

    [ $ec != 0 ] || return

    printf "$script: error: $*" 1>&2
    
    if [ $ec != 1 ]
    then
        printf ". Exiting with code $ec." 1>&2
    fi
    
    printf "\n" 1>&2
    exit $ec
}

#-----------------------------------------------------------------------------

warning ()
{
    printf "$script: warning: $*\n" 1>&2
}

#-----------------------------------------------------------------------------

info ()
{
    printf "$script: $*\n" 1>&2
}

#-----------------------------------------------------------------------------

is_command_available ()
{
    command -v $1 &> /dev/null
}

#-----------------------------------------------------------------------------

is_command_available_or_error ()
{
    is_command_available $1 ||  \
        error "program $1$2 is not in the path or cannot be run"
}

#-----------------------------------------------------------------------------

guarded ()
{
    is_command_available_or_error $1
    eval "$*" || error $? "cannot $*"
}

#-----------------------------------------------------------------------------

guarded rm    -rf $SIM_DIR
guarded mkdir -p  $SIM_DIR
guarded cd        $SIM_DIR

#-----------------------------------------------------------------------------

run_iverilog=0
run_gtkwave=0
run_vsim=0

is_command_available $IVERILOG && run_iverilog=1
is_command_available $GTKWAVE  && run_gtkwave=1
is_command_available $VSIM     && run_vsim=1

#-----------------------------------------------------------------------------

if [ $run_iverilog = 1 ] && [ $run_vsim = 1 ]
then
    if [ $iverilog_has_priority = 1 ]
    then
        run_vsim=0

    elif [ $vsim_has_priority = 1 ]
    then
        run_iverilog=0
    else
        printf "Two Verilog simulators are available to run:"
        printf " Icarus Verilog and Mentor ModelSim\n"
        printf "Which do you want to run?\n"

        options="Icarus ModelSim Both"
        PS3="Your choice: "

        select simulator in $options
        do
            case $simulator in
            Icarus)   run_vsim=0     ; break ;;
            ModelSim) run_iverilog=0 ; break ;;
            Both)                      break ;;
            esac
        done
    fi
fi

if [ $run_iverilog = 0 ] && [ $run_gtkwave = 1 ]
then
    run_gtkwave=0
fi

[ $run_iverilog = 0 ] && [ $run_vsim = 0 ] &&  \
    error "No Verilog simulator is available to run."  \
          "You need to install either Icarus Verilog"  \
          "or Mentor Questa / ModelSim."

#-----------------------------------------------------------------------------

if [ $run_iverilog = 1 ]
then
    $IVERILOG -g2005 -I .. ../*.v &> icarus.compile.log
    ec=$?

    if [ $ec != 0 ]
    then
        grep -i -A 5 error icarus.compile.log 2>&1
        error $ec Icarus Verilog compiler errors
    fi

    $VVP a.out &> icarus.simulate.log
    ec=$?

    sed -i .bak '/^VCD info: dumpfile dump.vcd opened for output.$/d'  \
        icarus.simulate.log

    if [ $ec != 0 ]
    then
        grep -i -A 5 error icarus.simulate.log 2>&1
        tail -n 5 icarus.simulate.log 2>&1
        error $ec Icarus Verilog simulator errors
    fi

    info Icarus Verilog simulation successfull
    tail -n 5 icarus.simulate.log
fi

#-----------------------------------------------------------------------------

if [ $run_gtkwave = 1 ]
then
    $GTKWAVE --dump dump.vcd --script ../gtkwave.tcl &> waveform.log
    ec=$?

    if [ $ec != 0 ]
    then
        grep -i -A 5 error waveform.log 2>&1
        error $ec "waveform viewer failed"
    fi
fi

#-----------------------------------------------------------------------------

if [ $run_vsim = 1 ]
then
    $VSIM -do ../modelsim.tcl &> modelsim.log
    ec=$?

    if [ $ec != 0 ]
    then
        grep -i -A 5 error modelsim.log 2>&1
        error $ec "ModelSim failed"
    fi
fi

#-----------------------------------------------------------------------------

exit 0
